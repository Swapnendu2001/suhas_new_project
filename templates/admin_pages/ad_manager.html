<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Manager Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles from original example */
        body {
            margin: 0;
            background-color: #030303;
            color: white;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .tab-button { transition: all 0.6s cubic-bezier(0.25, 0.4, 0.25, 1); }
        .tab-text {
            transition: all 0.8s cubic-bezier(0.25, 0.4, 0.25, 1);
            max-width: 0;
            opacity: 0;
            overflow: hidden;
            white-space: nowrap;
        }
        .tab-text.expanded { max-width: 200px; opacity: 1; margin-left: 0.5rem; }
        .tab-button.selected { padding-left: 1rem; padding-right: 1rem; }
        .tab-button:not(.selected) { padding-left: 0.75rem; padding-right: 0.75rem; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .anim-hidden-initial { opacity: 0; }
        /* Content section animation */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
            animation: slideDownContent 0.6s cubic-bezier(0.25, 0.4, 0.25, 1);
        }
        @keyframes slideDownContent {
            from { opacity: 0; transform: translateY(-20px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .container-box { max-width: 800px; margin: 0 auto; padding: 2rem; }
        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 2rem;
            color: white;
            letter-spacing: -0.025em;
        }
        
        /* Form styles matching admin_blogs */
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }
        .form-input, .form-select {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            color: white;
            transition: all 0.2s ease;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: rgb(59, 130, 246);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* Dropdown styles matching admin_blogs */
        .form-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%20viewBox%3D%220%200%20292.4%20292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2C197.9L159.7%2C69.8c-3-3-7.9-3-10.9%2C0L5.4%2C197.9c-3%2C3-3%2C7.9%2C0%2C10.9l10.9%2C10.9c3%2C3%2C7.9%2C3%2C10.9%2C0l120.7-120.7c3-3%2C7.9-3%2C10.9%2C0l120.7%2C120.7c3%2C3%2C7.9%2C3%2C10.9%2C0l10.9-10.9C290%2C205.8%2C290%2C200.8%2C287%2C197.9z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.6em;
            padding-right: 2.5rem;
        }
        
        .form-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 12px;
            background-color: rgb(59, 130, 246);
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .form-button:hover:not(:disabled) { background-color: rgb(37, 99, 235); }
        .form-button:disabled { background-color: rgba(59, 130, 246, 0.4); cursor: not-allowed; }
        
        .form-button-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .form-button-secondary:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Glass container */
        .glass-pill-container {
            display: inline-block;
            backdrop-filter: blur(35px);
            -webkit-backdrop-filter: blur(35px);
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 70px;
            padding: 6px;
        }
        
        /* Toggle button styles */
        .toggle-group button {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            color: rgba(255,255,255,0.6);
            background-color: transparent;
            border: none;
            transition: all 0.4s cubic-bezier(0.25, 0.4, 0.25, 1);
            transform: scale(1);
            position: relative;
            overflow: hidden;
        }
        .toggle-group button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #262626;
            border-radius: 20px;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.4s cubic-bezier(0.25, 0.4, 0.25, 1);
            z-index: -1;
        }
        .toggle-group button.active {
            color: white;
            transform: scale(1.05);
        }
        .toggle-group button.active::before {
            opacity: 1;
            transform: scale(1);
        }
        .toggle-group button:not(.active):hover {
            color: white;
            transform: scale(1.02);
        }
        .toggle-group button:not(.active):hover::before {
            opacity: 0.3;
            transform: scale(1);
        }
        
        /* Dropzone styles */
        .dropzone {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: rgba(255, 255, 255, 0.02);
        }
        .dropzone.dragover {
            border-color: rgb(59, 130, 246);
            background-color: rgba(59, 130, 246, 0.1);
        }
        .dropzone i, .dropzone p {
            transition: opacity 0.2s ease-in-out;
        }
        
        .file-input-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        .file-input-placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .organization-tile {
            position: relative;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            overflow: hidden; /* Ensure content is clipped to border-radius */
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease;
        }
        .organization-tile:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .organization-tile .actions {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 10;
            pointer-events: auto;
        }
        .organization-tile:hover .actions {
            opacity: 1;
            transform: translateY(0);
        }
        .organization-tile .actions button {
            border-radius: 9999px;
            padding: 0.5rem;
            background-color: rgba(0,0,0,0.5);
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
        }
        .organization-tile .actions button:hover {
            background-color: black;
        }
        
        /* Organization logo styles - 1:1 aspect ratio without cropping */
        .organization-logo {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Cover the area */
            border-radius: 0; /* Remove border-radius here, apply to container */
            border: none; /* Remove border here */
            background-color: transparent;
        }
        
        .ad-item {
            position: relative;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            overflow: hidden; /* Ensure content is clipped to border-radius */
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease;
        }
        .ad-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .ad-item .actions {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 10;
            pointer-events: auto;
        }
        .ad-item:hover .actions {
            opacity: 1;
            transform: translateY(0);
        }
        .ad-item .actions button {
            border-radius: 9999px;
            padding: 0.5rem;
            background-color: rgba(0,0,0,0.5);
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
        }
        .ad-item .actions button:hover {
            background-color: black;
        }
        
        .pagination-controls {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }
        .pagination-button {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border: none;
        }
        .pagination-button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-button.active {
            background-color: rgb(59, 130, 246);
        }
        
        /* Delete confirmation modal styles */
        .delete-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.4, 0.25, 1);
        }
        .delete-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .delete-modal-content {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh; /* Make modal content scrollable */
            overflow-y: auto; /* Enable vertical scrolling */
            text-align: center;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s cubic-bezier(0.25, 0.4, 0.25, 1);
        }
        .delete-modal.show .delete-modal-content {
            transform: scale(1) translateY(0);
        }
        .delete-modal-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1.5rem;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .delete-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
        }
        .delete-modal-message {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 2rem;
            line-height: 1.5;
        }
        .delete-modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        .delete-modal-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
        }
        .delete-modal-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .delete-modal-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .delete-modal-btn-delete {
            background: rgb(239, 68, 68);
            color: white;
        }
        .delete-modal-btn-delete:hover {
            background: rgb(220, 38, 38);
        }
    </style>
</head>
<body>
    <nav class="fixed top-0 left-0 right-0 z-50">
        <div class="flex justify-center py-6">
            <div style="backdrop-filter: blur(35px); -webkit-backdrop-filter: blur(35px); background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 70px; padding: 12px 20px;">
                <div id="navbarTabs" class="flex items-center gap-4 anim-hidden-initial" style="animation: slideDown 0.8s cubic-bezier(0.25, 0.4, 0.25, 1) 0.3s forwards;">
                </div>
            </div>
        </div>
    </nav>
    <div class="fixed inset-0 bg-gradient-to-br from-indigo-500/[0.03] via-transparent to-rose-500/[0.03] pointer-events-none"></div>
    <main class="pt-20 px-4">
        <!-- Organizations Section -->
        <section id="organizations" class="content-section active">
            <div class="container-box">
                <h2 class="section-title text-center">Manage Organizations</h2>
                <div class="bg-black/20 border border-white/10 rounded-[20px] p-6 md:p-8" style="border-width: 0px;">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <div class="flex-grow-0">
                            <label for="organizationSearch" class="form-label sr-only">Search Organizations</label>
                            <input type="text" id="organizationSearch" class="form-input" placeholder="Search organizations...">
                        </div>
                        <div class="flex-grow-0">
                            <button id="createNewOrganizationBtn" class="form-button">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Create New Organization
                            </button>
                        </div>
                    </div>
                    <div id="organizationsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Organization tiles will be rendered here by JS -->
                    </div>
                    <div id="no-organizations-found" class="text-center py-16 hidden">
                        <i data-lucide="building-2" class="w-16 h-16 mx-auto text-white/20 mb-4"></i>
                        <h3 class="text-xl font-medium text-white/80">No Organizations Found</h3>
                        <p class="text-white/50 mt-2">Create a new organization to get started.</p>
                    </div>
                    <div id="organizationPagination" class="pagination-controls">
                        <!-- Pagination buttons will be rendered here by JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Ads Section -->
        <section id="ads" class="content-section">
            <div class="container-box">
                <h2 class="section-title text-center">Manage Ads</h2>
                <div class="bg-black/20 border border-white/10 rounded-[20px] p-6 md:p-8" style="border-width: 0px;">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <div class="flex-grow-0">
                            <label for="organizationFilter" class="form-label sr-only">Filter by Organization</label>
                            <select id="organizationFilter" name="organization_id" class="form-select" style="background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); color: white;">
                                <option value="all" style="background-color: #1a1a1a; color: white;">Filter by Organization (All)</option>
                                <!-- Organization options will be populated by JS -->
                            </select>
                        </div>
                        <div class="flex-grow-0">
                            <button id="addNewAdBtn" class="form-button">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Add New Ad
                            </button>
                        </div>
                    </div>
                    <hr class="border-white/10 mb-6">
                    <div id="adsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Ad items will be rendered here by JS -->
                    </div>
                    <div id="no-ads-found" class="text-center py-16 hidden">
                        <i data-lucide="megaphone" class="w-16 h-16 mx-auto text-white/20 mb-4"></i>
                        <h3 class="text-xl font-medium text-white/80">No Ads Found</h3>
                        <p class="text-white/50 mt-2">Add a new ad to display here.</p>
                    </div>
                    <div id="adPagination" class="pagination-controls">
                        <!-- Pagination buttons will be rendered here by JS -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Create/Edit Organization Modal -->
    <div id="organizationModal" class="delete-modal">
        <div class="delete-modal-content">
            <h3 class="delete-modal-title text-center" id="organizationModalTitle">Create New Organization</h3>
            <form id="organizationForm" class="space-y-6 mt-6">
                
                <!-- Organization Name -->
                <div>
                    <label for="orgName" class="form-label text-left flex items-center">
                        <i data-lucide="building-2" class="w-4 h-4 mr-2"></i>
                        Organization Name <span class="text-red-400 ml-1">*</span>
                    </label>
                    <input type="text" id="orgName" name="org_name" class="form-input" placeholder="e.g., Tech Solutions Inc." required>
                </div>
                
                <!-- Organization Percentage -->
                <div>
                    <label for="orgPercentage" class="form-label text-left flex items-center">
                        <i data-lucide="percent" class="w-4 h-4 mr-2"></i>
                        Organization Percentage <span class="text-red-400 ml-1">*</span>
                    </label>
                    <input type="number" id="orgPercentage" name="org_percentage" class="form-input" placeholder="e.g., 75" min="0" max="100" required>
                </div>
                
                <!-- Organization Logo - Last position with drag/drop -->
                <div>
                    <label for="orgLogoUpload" class="form-label text-left flex items-center">
                        <i data-lucide="image" class="w-4 h-4 mr-2"></i>
                        Organization Logo
                    </label>
                    <div id="org-logo-dropzone" class="dropzone">
                        <i data-lucide="upload-cloud" class="w-8 h-8 mx-auto mb-2 text-white/50"></i>
                        <p id="org-logo-filename" class="file-input-placeholder">Click or drag image here</p>
                        <p class="text-xs text-white/40 mt-1">Supports JPG, PNG, WEBP (Max 10MB)</p>
                    </div>
                    <input type="file" id="orgLogoUpload" name="org_logo" class="hidden" accept="image/jpeg,image/jpg,image/png,image/webp,image/gif,image/bmp,image/svg+xml">
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" class="form-button form-button-secondary" id="organizationModalCancel">Cancel</button>
                    <button type="submit" class="form-button" id="organizationModalSave">Save Organization</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create/Edit Ad Modal -->
    <div id="adModal" class="delete-modal">
        <div class="delete-modal-content">
            <h3 class="delete-modal-title text-center" id="adModalTitle">Add New Ad</h3>
            <form id="adForm" class="space-y-6 mt-6">
                
                <!-- Organization -->
                <div>
                    <label for="adOrganization" class="form-label text-left flex items-center">
                        <i data-lucide="building-2" class="w-4 h-4 mr-2"></i>
                        Organization <span class="text-red-400 ml-1">*</span>
                    </label>
                    <select id="adOrganization" name="organization_id" class="form-select" required style="background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); color: white;">
                        <option value="" style="background-color: #1a1a1a; color: white;">Select an Organization</option>
                        <!-- Organization options will be populated by JS -->
                    </select>
                </div>
                
                <!-- Ad Title -->
                <div>
                    <label for="adTitle" class="form-label text-left flex items-center">
                        <i data-lucide="type" class="w-4 h-4 mr-2"></i>
                        Ad Title <span class="text-red-400 ml-1">*</span>
                    </label>
                    <input type="text" id="adTitle" name="ad_title" class="form-input" placeholder="e.g., Summer Sale Campaign" required>
                </div>
                
                <!-- Ad Description -->
                <div>
                    <label for="adDescription" class="form-label text-left flex items-center">
                        <i data-lucide="file-text" class="w-4 h-4 mr-2"></i>
                        Ad Description
                    </label>
                    <textarea id="adDescription" name="ad_description" class="form-input" rows="3" placeholder="Brief description of the ad content"></textarea>
                </div>
                
                <!-- Ad Hyperlink -->
                <div>
                    <label for="adHyperlink" class="form-label text-left flex items-center">
                        <i data-lucide="link" class="w-4 h-4 mr-2"></i>
                        Ad Hyperlink <span class="text-red-400 ml-1">*</span>
                    </label>
                    <input type="url" id="adHyperlink" name="ad_hyperlink" class="form-input" placeholder="e.g., https://example.com/sale" required>
                </div>
                
                <!-- Ad Image - Last position with drag/drop -->
                <div>
                    <label for="adImageUpload" class="form-label text-left flex items-center">
                        <i data-lucide="image" class="w-4 h-4 mr-2"></i>
                        Ad Image <span class="text-red-400 ml-1">*</span>
                    </label>
                    <div id="ad-image-dropzone" class="dropzone">
                        <i data-lucide="upload-cloud" class="w-8 h-8 mx-auto mb-2 text-white/50"></i>
                        <p id="ad-image-filename" class="file-input-placeholder">Click or drag image here</p>
                        <p class="text-xs text-white/40 mt-1">Supports JPG, PNG, WEBP (Max 10MB)</p>
                    </div>
                    <input type="file" id="adImageUpload" name="ad_image" class="hidden" accept="image/jpeg,image/jpg,image/png,image/webp,image/gif,image/bmp,image/svg+xml" required>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" class="form-button form-button-secondary" id="adModalCancel">Cancel</button>
                    <button type="submit" class="form-button" id="adModalSave">Save Ad</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="delete-modal">
        <div class="delete-modal-content">
            <div class="delete-modal-icon">
                <i data-lucide="trash-2" class="w-8 h-8 text-red-400"></i>
            </div>
            <h3 class="delete-modal-title">Confirm Deletion</h3>
            <p class="delete-modal-message" id="deleteModalMessage">
                Are you sure you want to delete this item? This action cannot be undone.
            </p>
            <div class="delete-modal-actions">
                <button class="delete-modal-btn delete-modal-btn-cancel" id="deleteModalCancel">
                    Cancel
                </button>
                <button class="delete-modal-btn delete-modal-btn-delete" id="deleteModalConfirm">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <script>
        let organizations = [];
        let ads = [];
        let expandableTabs;

        const ORGS_PER_PAGE = 6;
        const ADS_PER_PAGE = 6;
        let currentOrgPage = 1;
        let currentAdPage = 1;
        let currentAdFilterOrg = 'all';

        class ExpandableTabs {
            constructor(container, options = {}) {
                this.container = container;
                this.tabs = options.tabs || [];
                this.activeColor = options.activeColor || 'text-blue-600';
                this.onChange = options.onChange || (() => {});
                this.selected = null;
                this.init();
            }
            init() { this.render(); this.bindEvents(); }
            render() {
                this.container.innerHTML = '';
                this.tabs.forEach((tab, index) => {
                    const button = this.createTabButton(tab, index);
                    this.container.appendChild(button);
                });
            }
            createTabButton(tab, index) {
                const button = document.createElement('button');
                const isSelected = this.selected === index;
                button.className = `tab-button relative flex items-center text-sm font-medium tracking-wide transition-all duration-[600ms] ${isSelected ? 'selected' : ''}`;
                button.style.color = isSelected ? (this.activeColor || 'rgb(147, 197, 253)') : 'rgba(255, 255, 255, 0.6)';
                button.dataset.index = index;
                button.innerHTML = `
                    <div class="flex-shrink-0"><i data-lucide="${tab.icon}" class="w-4 h-4"></i></div>
                    <span class="tab-text ${isSelected ? 'expanded' : ''}">${tab.title}</span>
                `;
                button.addEventListener('mouseenter', () => !button.classList.contains('selected') && (button.style.color = 'rgba(255, 255, 255, 0.9)'));
                button.addEventListener('mouseleave', () => !button.classList.contains('selected') && (button.style.color = 'rgba(255, 255, 255, 0.6)'));
                return button;
            }
            handleSelect(index) {
                this.selected = index;
                const buttons = this.container.querySelectorAll('.tab-button');
                buttons.forEach(button => {
                    const buttonIndex = parseInt(button.dataset.index);
                    const textElement = button.querySelector('.tab-text');
                    const isSelected = this.selected === buttonIndex;
                    button.classList.toggle('selected', isSelected);
                    textElement.classList.toggle('expanded', isSelected);
                    button.style.color = isSelected ? (this.activeColor || 'rgb(147, 197, 253)') : 'rgba(255, 255, 255, 0.6)';
                });
                this.onChange(this.selected);
            }
            bindEvents() {
                this.container.addEventListener('click', (e) => {
                    const button = e.target.closest('.tab-button');
                    if (button && button.dataset.index !== undefined) {
                        this.handleSelect(parseInt(button.dataset.index));
                    }
                });
            }
        }

        function showContentSection(tabTitle) {
            if (tabTitle === 'Home') {
                window.location.href = '/admin_login';
                return;
            }
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            let sectionId = '';
            if (tabTitle === 'Organizations') sectionId = 'organizations';
            if (tabTitle === 'Ads') sectionId = 'ads';
            if (sectionId) {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.add('active');
                    if (sectionId === 'organizations') {
                        renderOrganizations();
                    } else if (sectionId === 'ads') {
                        renderAds();
                        populateOrganizationFilter();
                        populateAdOrganizationDropdown();
                    }
                }
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            let bgColor = type === 'error' ? 'bg-red-600' : type === 'warning' ? 'bg-yellow-600' : 'bg-green-600';
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-[1050] transition-all duration-300`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => { document.body.removeChild(toast); }, 300);
            }, 3000);
        }

        // --- Organization Management ---
        async function fetchOrganizations() {
            try {
                const response = await fetch('/api/organizations');
                if (!response.ok) throw new Error('Failed to fetch organizations');
                organizations = await response.json();
            } catch (error) {
                console.error('Error fetching organizations:', error);
                showToast('Failed to load organizations.', 'error');
            }
        }

        function renderOrganizations() {
            const organizationsGrid = document.getElementById('organizationsGrid');
            const noOrganizationsFound = document.getElementById('no-organizations-found');
            const organizationSearchInput = document.getElementById('organizationSearch');
            const searchTerm = organizationSearchInput.value.toLowerCase();
            organizationsGrid.innerHTML = '';

            const filteredOrgs = organizations.filter(org =>
                org.organization.toLowerCase().includes(searchTerm)
            );

            const startIndex = (currentOrgPage - 1) * ORGS_PER_PAGE;
            const endIndex = startIndex + ORGS_PER_PAGE;
            const paginatedOrgs = filteredOrgs.slice(startIndex, endIndex);

            if (paginatedOrgs.length === 0) {
                noOrganizationsFound.classList.remove('hidden');
                organizationsGrid.classList.add('hidden');
            } else {
                noOrganizationsFound.classList.add('hidden');
                organizationsGrid.classList.remove('hidden');
                paginatedOrgs.forEach(org => {
                    const orgTile = document.createElement('div');
                    orgTile.className = 'organization-tile';
                    orgTile.innerHTML = `
                        <div class="relative w-full h-32 overflow-hidden rounded-t-lg">
                            <img src="${org.logo || 'https://via.placeholder.com/128x96'}" alt="${org.organization} Logo" class="organization-logo">
                            <div class="actions absolute top-2 right-2 flex gap-2 z-10">
                                <button class="action-btn" data-action="view-ads" data-id="${org.id}" title="View Ads"><i data-lucide="megaphone" class="w-4 h-4 text-white"></i></button>
                                <button class="action-btn" data-action="edit-org" data-id="${org.id}" title="Edit Organization"><i data-lucide="pencil" class="w-4 h-4 text-white"></i></button>
                                <button class="action-btn" data-action="delete-org" data-id="${org.id}" data-name="${org.organization}" title="Delete Organization"><i data-lucide="trash" class="w-4 h-4 text-white"></i></button>
                            </div>
                        </div>
                        <div class="p-4 flex-grow flex flex-col justify-between" style="min-height: 100px;">
                            <div>
                                <h3 class="text-xl font-semibold text-white mb-1">${org.organization}</h3>
                                <p class="text-white/70 text-sm mb-1">Share: ${org.percentage}%</p>
                                <p class="text-white/70 text-sm mt-1">Ads: ${org.ad_count}</p>
                            </div>
                        </div>
                    `;
                    organizationsGrid.appendChild(orgTile);
                });
            }
            renderOrganizationPagination(filteredOrgs.length);
            lucide.createIcons();
        }

        function renderOrganizationPagination(totalOrgs) {
            const paginationContainer = document.getElementById('organizationPagination');
            paginationContainer.innerHTML = '';
            const totalPages = Math.ceil(totalOrgs / ORGS_PER_PAGE);

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.className = `pagination-button ${i === currentOrgPage ? 'active' : ''}`;
                button.textContent = i;
                button.addEventListener('click', () => {
                    currentOrgPage = i;
                    renderOrganizations();
                });
                paginationContainer.appendChild(button);
            }
        }

        function openOrganizationModal(org = null) {
            const modal = document.getElementById('organizationModal');
            const title = document.getElementById('organizationModalTitle');
            const form = document.getElementById('organizationForm');
            const orgLogoUpload = document.getElementById('orgLogoUpload');
            const orgLogoFilename = document.getElementById('org-logo-filename');
            const orgName = document.getElementById('orgName');
            const orgPercentage = document.getElementById('orgPercentage');
            const saveBtn = document.getElementById('organizationModalSave');

            form.reset();
            orgLogoFilename.textContent = 'Click or drag image here';
            orgLogoFilename.classList.add('file-input-placeholder');

            if (org) {
                title.textContent = 'Edit Organization';
                orgName.value = org.organization;
                orgPercentage.value = org.percentage;
                saveBtn.textContent = 'Save Changes';
                form.dataset.editId = org.id;
            } else {
                title.textContent = 'Create New Organization';
                saveBtn.textContent = 'Create Organization';
                delete form.dataset.editId;
            }

            modal.classList.add('show');
        }

        function closeOrganizationModal() {
            document.getElementById('organizationModal').classList.remove('show');
        }

        // Setup drag and drop for organization logo
        function setupOrgLogoDragDrop() {
            const dropzone = document.getElementById('org-logo-dropzone');
            const fileInput = document.getElementById('orgLogoUpload');
            const filenameSpan = document.getElementById('org-logo-filename');

            dropzone.addEventListener('click', () => fileInput.click());

            // Drag and drop functionality
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, () => dropzone.classList.add('dragover'));
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, () => dropzone.classList.remove('dragover'));
            });

            dropzone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleOrgLogoFile(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleOrgLogoFile(e.target.files[0]);
                }
            });

            function handleOrgLogoFile(file) {
                if (file && file.type.startsWith('image/')) {
                    filenameSpan.textContent = file.name;
                    filenameSpan.classList.remove('file-input-placeholder');
                } else {
                    showToast('Please select a valid image file.', 'error');
                }
            }
        }

        document.getElementById('createNewOrganizationBtn').addEventListener('click', () => openOrganizationModal());
        document.getElementById('organizationModalCancel').addEventListener('click', closeOrganizationModal);
        document.getElementById('organizationModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('organizationModal')) closeOrganizationModal();
        });

        document.getElementById('organizationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const orgId = form.dataset.editId;
            const formData = new FormData();
            formData.append('organization', document.getElementById('orgName').value);
            formData.append('percentage', document.getElementById('orgPercentage').value);
            const logoFile = document.getElementById('orgLogoUpload').files[0];
            if (logoFile) {
                formData.append('org_logo', logoFile);
            }

            const url = orgId ? `/api/organizations/${orgId}` : '/api/organizations';
            const method = orgId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to save organization');
                }

                showToast(`Organization ${orgId ? 'updated' : 'created'} successfully!`, 'success');
                // Refresh the page to reflect all changes
                location.reload();
            } catch (error) {
                console.error('Error saving organization:', error);
                showToast(error.message, 'error');
            }
        });

        document.getElementById('organizationsGrid').addEventListener('click', (e) => {
            const actionBtn = e.target.closest('.action-btn');
            if (!actionBtn) return;

            const action = actionBtn.dataset.action;
            const orgId = actionBtn.dataset.id;
            const org = organizations.find(o => o.id == orgId);

            if (!org) return;

            if (action === 'view-ads') {
                const adsTabIndex = expandableTabs.tabs.findIndex(tab => tab.title === 'Ads');
                if (adsTabIndex !== -1) {
                    currentAdFilterOrg = orgId;
                    currentAdPage = 1;
                    expandableTabs.handleSelect(adsTabIndex);
                }
                return;
            }

            if (action === 'edit-org') {
                openOrganizationModal(org);
            } else if (action === 'delete-org') {
                showDeleteModal(`organization "${org.organization}" and all associated ads`, async () => {
                    try {
                        const response = await fetch(`/api/organizations/${orgId}`, { method: 'DELETE' });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Failed to delete organization');
                        }
                        showToast(`Organization "${org.organization}" deleted successfully!`, 'success');
                        // Refresh the page to reflect all changes
                        location.reload();
                    } catch (error) {
                        console.error('Error deleting organization:', error);
                        showToast(error.message, 'error');
                    }
                });
            }
        });

        document.getElementById('organizationSearch').addEventListener('input', () => {
            currentOrgPage = 1;
            renderOrganizations();
        });

        // --- Ad Management ---
        async function fetchAds() {
            try {
                const response = await fetch('/api/ads');
                if (!response.ok) throw new Error('Failed to fetch ads');
                ads = await response.json();
            } catch (error) {
                console.error('Error fetching ads:', error);
                showToast('Failed to load ads.', 'error');
            }
        }

        function renderAds() {
            const adsList = document.getElementById('adsList');
            const noAdsFound = document.getElementById('no-ads-found');
            adsList.innerHTML = '';

            const orgToFilter = organizations.find(o => o.id == currentAdFilterOrg);
            const orgNameToFilter = orgToFilter ? orgToFilter.organization : null;

            const filteredAds = currentAdFilterOrg === 'all'
                ? ads
                : ads.filter(ad => ad.organization === orgNameToFilter);

            const startIndex = (currentAdPage - 1) * ADS_PER_PAGE;
            const endIndex = startIndex + ADS_PER_PAGE;
            const paginatedAds = filteredAds.slice(startIndex, endIndex);

            if (paginatedAds.length === 0) {
                noAdsFound.classList.remove('hidden');
                adsList.classList.add('hidden');
            } else {
                noAdsFound.classList.add('hidden');
                adsList.classList.remove('hidden');
                paginatedAds.forEach(ad => {
                    const adItem = document.createElement('div');
                    adItem.className = 'ad-item';
                    const org = organizations.find(o => o.organization == ad.organization);
                    const orgName = org ? org.organization : 'Unknown';
                    adItem.innerHTML = `
                        <div class="relative w-full h-32 overflow-hidden rounded-t-lg">
                            <img src="${ad.image || 'https://via.placeholder.com/100x75'}" alt="${ad.title} Thumbnail" class="w-full h-full object-cover">
                            <div class="actions absolute top-2 right-2 flex gap-2 z-10">
                                <button class="action-btn" data-action="edit-ad" data-id="${ad.id}" title="Edit Ad"><i data-lucide="pencil" class="w-4 h-4 text-white"></i></button>
                                <button class="action-btn" data-action="delete-ad" data-id="${ad.id}" data-name="${ad.title}" title="Delete Ad"><i data-lucide="trash" class="w-4 h-4 text-white"></i></button>
                            </div>
                        </div>
                        <div class="p-4 flex-grow flex flex-col justify-between" style="min-height: 100px;">
                            <div>
                                <h3 class="text-xl font-semibold text-white mb-1">${ad.title}</h3>
                                <p class="text-white/70 text-sm mb-1">${orgName}</p>
                                <a href="${ad.url}" target="_blank" class="text-blue-400 hover:underline text-sm block truncate">${ad.url}</a>
                            </div>
                        </div>
                    `;
                    adsList.appendChild(adItem);
                });
            }
            renderAdPagination(filteredAds.length);
            lucide.createIcons();
        }

        function renderAdPagination(totalAds) {
            const paginationContainer = document.getElementById('adPagination');
            paginationContainer.innerHTML = '';
            const totalPages = Math.ceil(totalAds / ADS_PER_PAGE);

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.className = `pagination-button ${i === currentAdPage ? 'active' : ''}`;
                button.textContent = i;
                button.addEventListener('click', () => {
                    currentAdPage = i;
                    renderAds();
                });
                paginationContainer.appendChild(button);
            }
        }

        function populateOrganizationFilter() {
            const filter = document.getElementById('organizationFilter');
            filter.innerHTML = '<option value="all" style="background-color: #1a1a1a; color: white;">Filter by Organization (All)</option>';
            organizations.forEach(org => {
                const option = document.createElement('option');
                option.value = org.id;
                option.textContent = org.organization;
                option.style.backgroundColor = '#1a1a1a';
                option.style.color = 'white';
                filter.appendChild(option);
            });
            filter.value = currentAdFilterOrg;
        }

        function populateAdOrganizationDropdown() {
            const dropdown = document.getElementById('adOrganization');
            dropdown.innerHTML = '<option value="" style="background-color: #1a1a1a; color: white;">Select an Organization</option>';
            organizations.forEach(org => {
                const option = document.createElement('option');
                option.value = org.id;
                option.textContent = org.organization;
                option.style.backgroundColor = '#1a1a1a';
                option.style.color = 'white';
                dropdown.appendChild(option);
            });
        }

        function openAdModal(ad = null) {
            const modal = document.getElementById('adModal');
            const title = document.getElementById('adModalTitle');
            const form = document.getElementById('adForm');
            const adImageUpload = document.getElementById('adImageUpload');
            const adImageFilename = document.getElementById('ad-image-filename');
            const adOrganization = document.getElementById('adOrganization');
            const adTitle = document.getElementById('adTitle');
            const adDescription = document.getElementById('adDescription');
            const adHyperlink = document.getElementById('adHyperlink');
            const saveBtn = document.getElementById('adModalSave');

            form.reset();
            adImageFilename.textContent = 'Click or drag image here';
            adImageFilename.classList.add('file-input-placeholder');
            populateAdOrganizationDropdown();

            if (ad) {
                title.textContent = 'Edit Ad';
                adOrganization.value = ad.organization_id;
                adTitle.value = ad.title;
                adDescription.value = ad.description || '';
                adHyperlink.value = ad.url;
                saveBtn.textContent = 'Save Changes';
                form.dataset.editId = ad.id;
                // Make image not required for edit
                adImageUpload.removeAttribute('required');
            } else {
                title.textContent = 'Add New Ad';
                saveBtn.textContent = 'Add Ad';
                delete form.dataset.editId;
                // Make image required for new ad
                adImageUpload.setAttribute('required', 'required');
            }

            modal.classList.add('show');
        }

        function closeAdModal() {
            document.getElementById('adModal').classList.remove('show');
        }

        // Setup drag and drop for ad image
        function setupAdImageDragDrop() {
            const dropzone = document.getElementById('ad-image-dropzone');
            const fileInput = document.getElementById('adImageUpload');
            const filenameSpan = document.getElementById('ad-image-filename');

            dropzone.addEventListener('click', () => fileInput.click());

            // Drag and drop functionality
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, () => dropzone.classList.add('dragover'));
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, () => dropzone.classList.remove('dragover'));
            });

            dropzone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleAdImageFile(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleAdImageFile(e.target.files[0]);
                }
            });

            function handleAdImageFile(file) {
                if (file && file.type.startsWith('image/')) {
                    filenameSpan.textContent = file.name;
                    filenameSpan.classList.remove('file-input-placeholder');
                } else {
                    showToast('Please select a valid image file.', 'error');
                }
            }
        }

        document.getElementById('addNewAdBtn').addEventListener('click', () => openAdModal());
        document.getElementById('adModalCancel').addEventListener('click', closeAdModal);
        document.getElementById('adModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('adModal')) closeAdModal();
        });

        document.getElementById('adForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const adId = form.dataset.editId;
            const formData = new FormData();
            const orgElement = document.getElementById('adOrganization');
            formData.append('organization_id', orgElement.value);
            formData.append('organization', orgElement.options[orgElement.selectedIndex].text);
            formData.append('title', document.getElementById('adTitle').value);
            formData.append('description', document.getElementById('adDescription').value);
            formData.append('url', document.getElementById('adHyperlink').value);

            const adImageFile = document.getElementById('adImageUpload').files[0];
            if (adImageFile) {
                formData.append('ad_image', adImageFile);
            }
            
            const url = adId ? `/api/ads/${adId}` : '/api/ads_post';
            const method = adId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to save ad');
                }

                showToast(`Ad ${adId ? 'updated' : 'created'} successfully!`, 'success');
                // Refresh the page to reflect all changes
                location.reload();
            } catch (error) {
                console.error('Error saving ad:', error);
                showToast(error.message, 'error');
            }
        });

        document.getElementById('adsList').addEventListener('click', (e) => {
            const actionBtn = e.target.closest('.action-btn');
            if (!actionBtn) return;

            const action = actionBtn.dataset.action;
            const adId = actionBtn.dataset.id;
            const adName = actionBtn.dataset.name;
            const ad = ads.find(a => a.id == adId);

            if (!ad) return;

            if (action === 'edit-ad') {
                openAdModal(ad);
            } else if (action === 'delete-ad') {
                showDeleteModal(`ad "${adName}"`, async () => {
                    try {
                        const response = await fetch(`/api/ads/${adId}`, { method: 'DELETE' });
                        if (!response.ok) {
                           const errorData = await response.json();
                            throw new Error(errorData.message || 'Failed to delete ad');
                        }
                        showToast(`Ad "${adName}" deleted successfully!`, 'success');
                        // Refresh the page to reflect all changes
                        location.reload();
                    } catch (error) {
                        console.error('Error deleting ad:', error);
                        showToast(error.message, 'error');
                    }
                });
            }
        });

        document.getElementById('organizationFilter').addEventListener('change', (e) => {
            currentAdFilterOrg = e.target.value;
            currentAdPage = 1;
            renderAds();
        });

        // --- General Delete Modal ---
        let confirmDeleteCallback = null;
        function showDeleteModal(itemName, onConfirm) {
            const modal = document.getElementById('deleteModal');
            const message = document.getElementById('deleteModalMessage');
            let confirmBtn = document.getElementById('deleteModalConfirm');
            let cancelBtn = document.getElementById('deleteModalCancel');

            // This is a trick to remove all previous event listeners from the buttons.
            let newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            confirmBtn = newConfirmBtn;

            let newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            cancelBtn = newCancelBtn;

            message.innerHTML = `Are you sure you want to delete <strong>${itemName}</strong>?<br>This action cannot be undone.`;
            modal.classList.add('show');
            
            const handleConfirm = () => {
                hideDeleteModal();
                if (onConfirm) {
                    onConfirm();
                }
            };

            const handleCancel = () => {
                hideDeleteModal();
            };

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);

            const handleBackdrop = (e) => {
                if (e.target === modal) {
                    handleCancel();
                }
            };
            modal.addEventListener('click', handleBackdrop);

            const onEscape = (e) => {
                if (e.key === 'Escape') {
                    handleCancel();
                    // Clean up listeners when modal is closed
                    modal.removeEventListener('click', handleBackdrop);
                    document.removeEventListener('keydown', onEscape);
                }
            };
            document.addEventListener('keydown', onEscape);
        }

        function hideDeleteModal() {
            const modal = document.getElementById('deleteModal');
            modal.classList.remove('show');
            // No need to nullify callback here as it's passed directly
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async function() {
            lucide.createIcons();
            
            // Setup drag and drop
            setupOrgLogoDragDrop();
            setupAdImageDragDrop();
            
            const navbarTabsData = [
                { title: "Admin Panel Home", icon: "home" },
                { title: "Organizations", icon: "building-2" },
                { title: "Ads", icon: "megaphone" }
            ];
            expandableTabs = new ExpandableTabs(document.getElementById('navbarTabs'), {
                tabs: navbarTabsData,
                activeColor: 'text-blue-400',
                onChange: (index) => {
                    if (index !== null) {
                        if (navbarTabsData[index].title === "Admin Panel Home") {
                            window.location.href = '/admin_login';
                        } else {
                            showContentSection(navbarTabsData[index].title);
                        }
                    }
                }
            });
            
            // Initial data fetch
            await Promise.all([fetchOrganizations(), fetchAds()]);

            // Set default tab after data is loaded
            expandableTabs.handleSelect(1);
        });
    </script>
</body>
</html>