<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Manager Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles from original example */
        body {
            margin: 0;
            background-color: #030303;
            color: white;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .tab-button { transition: all 0.6s cubic-bezier(0.25, 0.4, 0.25, 1); }
        .tab-text {
            transition: all 0.8s cubic-bezier(0.25, 0.4, 0.25, 1);
            max-width: 0;
            opacity: 0;
            overflow: hidden;
            white-space: nowrap;
        }
        .tab-text.expanded { max-width: 200px; opacity: 1; margin-left: 0.5rem; }
        .tab-button.selected { padding-left: 1rem; padding-right: 1rem; }
        .tab-button:not(.selected) { padding-left: 0.75rem; padding-right: 0.75rem; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .anim-hidden-initial { opacity: 0; }
        /* UPDATED: Content section animation to match navbar */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
            animation: slideDownContent 0.6s cubic-bezier(0.25, 0.4, 0.25, 1);
        }
        @keyframes slideDownContent {
            from { opacity: 0; transform: translateY(-20px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .container-box { max-width: 800px; margin: 0 auto; padding: 2rem; }
        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 2rem;
            color: white;
            letter-spacing: -0.025em;
        }
        .form-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 20px; /* UPDATED */
            background-color: rgb(59, 130, 246);
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .form-button:hover:not(:disabled) { background-color: rgb(37, 99, 235); }
        .form-button:disabled { background-color: rgba(59, 130, 246, 0.4); cursor: not-allowed; }
        /* NEW: Glass container for toggles */
        .glass-pill-container {
            display: inline-block;
            backdrop-filter: blur(35px);
            -webkit-backdrop-filter: blur(35px);
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 70px;
            padding: 6px;
        }
        /* UPDATED: Toggle button styles with enhanced animations */
        .toggle-group button {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            color: rgba(255,255,255,0.6);
            background-color: transparent;
            border: none;
            transition: all 0.4s cubic-bezier(0.25, 0.4, 0.25, 1);
            transform: scale(1);
            position: relative;
            overflow: hidden;
        }
        .toggle-group button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #262626;
            border-radius: 20px;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.4s cubic-bezier(0.25, 0.4, 0.25, 1);
            z-index: -1;
        }
        .toggle-group button.active {
            color: white;
            transform: scale(1.05);
        }
        .toggle-group button.active::before {
            opacity: 1;
            transform: scale(1);
        }
        .toggle-group button:not(.active):hover {
            color: white;
            transform: scale(1.02);
        }
        .toggle-group button:not(.active):hover::before {
            opacity: 0.3;
            transform: scale(1);
        }
        /* Icon and text animations */
        .toggle-group button i,
        .toggle-group button span {
            transition: transform 0.3s cubic-bezier(0.25, 0.4, 0.25, 1);
            position: relative;
            z-index: 1;
        }
        .toggle-group button.active i {
            transform: rotate(360deg) scale(1.1);
        }
        .dropzone {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 20px; /* UPDATED */
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: rgba(255, 255, 255, 0.02);
        }
        .dropzone.dragover {
            border-color: rgb(59, 130, 246);
            background-color: rgba(59, 130, 246, 0.1);
        }
        /* Dropzone content animations */
        .dropzone i,
        .dropzone p {
            transition: opacity 0.2s ease-in-out;
        }
        .file-queue-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 20px; /* UPDATED */
            background-color: rgba(255, 255, 255, 0.05);
        }
        .gallery-item {
            position: relative;
            overflow: hidden;
            border-radius: 20px; /* UPDATED */
            transition: all 0.2s ease;
            background-color: rgba(255, 255, 255, 0.03);
        }
        .gallery-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .gallery-item .overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .gallery-item:hover .overlay {
            opacity: 1;
        }
        .gallery-item .actions {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 10; /* Added z-index to ensure buttons are on top */
            pointer-events: auto; /* Ensure pointer events are enabled */
        }
        .gallery-item:hover .actions {
            opacity: 1;
            transform: translateY(0);
        }
        .gallery-item .actions button {
            border-radius: 9999px; /* UPDATED to circle */
            padding: 0.5rem;
            background-color: rgba(0,0,0,0.5);
            transition: background-color 0.2s;
        }
        .gallery-item .actions button:hover {
             background-color: black; /* Grey hover for all buttons */
        }
        /* Search input container styles */
        .search-input-container {
            position: relative;
        }
        .search-input-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 1px;
            background-color: rgba(255, 255, 255, 0.6);
            transform: translateX(-50%);
            transition: width 0.3s ease-in-out;
        }
        .search-input-container:hover::after {
            width: 100%;
        }
        .search-input-container.focused::after {
            width: 100%;
        }
        /* Search input styles */
        .search-input {
            background-color: transparent;
            border: none;
            color: white;
            transition: all 0.3s ease-in-out;
        }
        .search-input:focus {
            outline: none;
        }
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        /* Delete confirmation modal styles */
        .delete-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.4, 0.25, 1);
        }
        .delete-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .delete-modal-content {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            text-align: center;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s cubic-bezier(0.25, 0.4, 0.25, 1);
        }
        .delete-modal.show .delete-modal-content {
            transform: scale(1) translateY(0);
        }
        .delete-modal-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1.5rem;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .delete-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
        }
        .delete-modal-message {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 2rem;
            line-height: 1.5;
        }
        .delete-modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        .delete-modal-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
        }
        .delete-modal-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .delete-modal-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .delete-modal-btn-delete {
            background: rgb(239, 68, 68);
            color: white;
        }
        .delete-modal-btn-delete:hover {
            background: rgb(220, 38, 38);
        }
        /* NEW: Form input styles */
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }
        .form-input, .file-input-display, .form-select {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            color: white;
            transition: all 0.2s ease;
            /* Ensure consistent styling with form-input from admin_blogs.html */
            -webkit-appearance: none; /* Remove default dropdown arrow */
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%20viewBox%3D%220%200%20292.4%20292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2C197.9L159.7%2C69.8c-3-3-7.9-3-10.9%2C0L5.4%2C197.9c-3%2C3-3%2C7.9%2C0%2C10.9l10.9%2C10.9c3%2C3%2C7.9%2C3%2C10.9%2C0l120.7-120.7c3-3%2C7.9-3%2C10.9%2C0l120.7%2C120.7c3%2C3%2C7.9%2C3%2C10.9%2C0l10.9-10.9C290%2C205.8%2C290%2C200.8%2C287%2C197.9z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.6em;
            padding-right: 2.5rem; /* Make space for the custom arrow */
        }
        .form-input:focus, .file-input-display:focus-within, .form-select:focus {
            outline: none;
            border-color: rgb(59, 130, 246);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        .file-input-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        .file-input-placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .organization-tile {
            position: relative;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.2s ease;
        }
        .organization-tile:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .organization-tile .actions {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 10;
            pointer-events: auto;
        }
        .organization-tile:hover .actions {
            opacity: 1;
            transform: translateY(0);
        }
        .organization-tile .actions button {
            border-radius: 9999px;
            padding: 0.5rem;
            background-color: rgba(0,0,0,0.5);
            transition: background-color 0.2s;
        }
        .organization-tile .actions button:hover {
            background-color: black;
        }
        .ad-item {
            position: relative;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.2s ease;
        }
        .ad-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .ad-item .actions {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 10;
            pointer-events: auto;
        }
        .ad-item:hover .actions {
            opacity: 1;
            transform: translateY(0);
        }
        .ad-item .actions button {
            border-radius: 9999px;
            padding: 0.5rem;
            background-color: rgba(0,0,0,0.5);
            transition: background-color 0.2s;
        }
        .ad-item .actions button:hover {
            background-color: black;
        }
        .pagination-controls {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }
        .pagination-button {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .pagination-button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-button.active {
            background-color: rgb(59, 130, 246);
        }
    </style>
</head>
<body>
    <nav class="fixed top-0 left-0 right-0 z-50">
        <div class="flex justify-center py-6">
            <div style="backdrop-filter: blur(35px); -webkit-backdrop-filter: blur(35px); background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 70px; padding: 12px 20px;">
                <div id="navbarTabs" class="flex items-center gap-4 anim-hidden-initial" style="animation: slideDown 0.8s cubic-bezier(0.25, 0.4, 0.25, 1) 0.3s forwards;">
                </div>
            </div>
        </div>
    </nav>
    <div class="fixed inset-0 bg-gradient-to-br from-indigo-500/[0.03] via-transparent to-rose-500/[0.03] pointer-events-none"></div>
    <main class="pt-20 px-4">
        <!-- Organizations Section -->
        <section id="organizations" class="content-section active">
            <div class="container-box">
                <h2 class="section-title text-center">Manage Organizations</h2>
                <div class="bg-black/20 border border-white/10 rounded-[20px] p-6 md:p-8" style="border-width: 0px;">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <div class="w-full sm:w-auto flex-grow">
                            <label for="organizationSearch" class="form-label sr-only">Search Organizations</label>
                            <input type="text" id="organizationSearch" class="form-input" placeholder="Search organizations...">
                        </div>
                        <div class="w-full sm:w-auto">
                            <button id="createNewOrganizationBtn" class="form-button w-full">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Create New Organization
                            </button>
                        </div>
                    </div>
                    <div id="organizationsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Organization tiles will be rendered here by JS -->
                    </div>
                    <div id="no-organizations-found" class="text-center py-16 hidden">
                        <i data-lucide="building-2" class="w-16 h-16 mx-auto text-white/20 mb-4"></i>
                        <h3 class="text-xl font-medium text-white/80">No Organizations Found</h3>
                        <p class="text-white/50 mt-2">Create a new organization to get started.</p>
                    </div>
                    <div id="organizationPagination" class="pagination-controls">
                        <!-- Pagination buttons will be rendered here by JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Ads Section -->
        <section id="ads" class="content-section">
            <div class="container-box">
                <h2 class="section-title text-center">Manage Ads</h2>
                <div class="bg-black/20 border border-white/10 rounded-[20px] p-6 md:p-8" style="border-width: 0px;">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                        <div class="w-full sm:w-auto flex-grow">
                            <label for="organizationFilter" class="form-label sr-only">Filter by Organization</label>
                            <select id="organizationFilter" class="form-select">
                                <option value="all">Filter by Organization (All)</option>
                                <!-- Organization options will be populated by JS -->
                            </select>
                        </div>
                        <div class="w-full sm:w-auto">
                            <button id="addNewAdBtn" class="form-button w-full">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Add New Ad
                            </button>
                        </div>
                    </div>
                    <hr class="border-white/10 mb-6">
                    <div id="adsList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Ad items will be rendered here by JS -->
                    </div>
                    <div id="no-ads-found" class="text-center py-16 hidden">
                        <i data-lucide="megaphone" class="w-16 h-16 mx-auto text-white/20 mb-4"></i>
                        <h3 class="text-xl font-medium text-white/80">No Ads Found</h3>
                        <p class="text-white/50 mt-2">Add a new ad to display here.</p>
                    </div>
                    <div id="adPagination" class="pagination-controls">
                        <!-- Pagination buttons will be rendered here by JS -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Create/Edit Organization Modal -->
    <div id="organizationModal" class="delete-modal">
        <div class="delete-modal-content">
            <h3 class="delete-modal-title" id="organizationModalTitle">Create New Organization</h3>
            <form id="organizationForm" class="space-y-4 mt-4">
                <div>
                    <label for="orgLogoUpload" class="form-label">Organization Logo</label>
                    <div id="org-logo-dropzone" class="file-input-display">
                        <span id="org-logo-filename" class="file-input-placeholder truncate pr-4">Click or drop image here</span>
                        <i data-lucide="image" class="w-5 h-5 text-white/50"></i>
                    </div>
                    <input type="file" id="orgLogoUpload" name="org_logo" class="hidden" accept="image/*">
                </div>
                <div>
                    <label for="orgName" class="form-label">Organization Name</label>
                    <input type="text" id="orgName" name="org_name" class="form-input" placeholder="e.g., Tech Solutions Inc." required>
                </div>
                <div>
                    <label for="orgPercentage" class="form-label">Organization Percentage</label>
                    <input type="number" id="orgPercentage" name="org_percentage" class="form-input" placeholder="e.g., 75" min="0" max="100" required>
                </div>
                <div class="delete-modal-actions">
                    <button type="button" class="delete-modal-btn delete-modal-btn-cancel" id="organizationModalCancel">Cancel</button>
                    <button type="submit" class="delete-modal-btn delete-modal-btn-delete" id="organizationModalSave">Save Organization</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create/Edit Ad Modal -->
    <div id="adModal" class="delete-modal">
        <div class="delete-modal-content">
            <h3 class="delete-modal-title" id="adModalTitle">Add New Ad</h3>
            <form id="adForm" class="space-y-4 mt-4">
                <div>
                    <label for="adOrganization" class="form-label">Organization</label>
                    <select id="adOrganization" name="organization_id" class="form-select" required>
                        <option value="">Select an Organization</option>
                        <!-- Organization options will be populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="adTitle" class="form-label">Ad Title</label>
                    <input type="text" id="adTitle" name="ad_title" class="form-input" placeholder="e.g., Summer Sale Campaign" required>
                </div>
                <div>
                    <label for="adDescription" class="form-label">Ad Description</label>
                    <textarea id="adDescription" name="ad_description" class="form-input" rows="3" placeholder="Brief description of the ad content"></textarea>
                </div>
                <div>
                    <label for="adHyperlink" class="form-label">Ad Hyperlink</label>
                    <input type="url" id="adHyperlink" name="ad_hyperlink" class="form-input" placeholder="e.g., https://example.com/sale" required>
                </div>
                <div>
                    <label for="adImageUpload" class="form-label">Ad Image</label>
                    <div id="ad-image-dropzone" class="file-input-display">
                        <span id="ad-image-filename" class="file-input-placeholder truncate pr-4">Click or drop image here</span>
                        <i data-lucide="image" class="w-5 h-5 text-white/50"></i>
                    </div>
                    <input type="file" id="adImageUpload" name="ad_image" class="hidden" accept="image/*">
                </div>
                <div class="delete-modal-actions">
                    <button type="button" class="delete-modal-btn delete-modal-btn-cancel" id="adModalCancel">Cancel</button>
                    <button type="submit" class="delete-modal-btn delete-modal-btn-delete" id="adModalSave">Save Ad</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal (reused for both organizations and ads) -->
    <div id="deleteModal" class="delete-modal">
        <div class="delete-modal-content">
            <div class="delete-modal-icon">
                <i data-lucide="trash-2" class="w-8 h-8 text-red-400"></i>
            </div>
            <h3 class="delete-modal-title">Confirm Deletion</h3>
            <p class="delete-modal-message" id="deleteModalMessage">
                Are you sure you want to delete this item? This action cannot be undone.
            </p>
            <div class="delete-modal-actions">
                <button class="delete-modal-btn delete-modal-btn-cancel" id="deleteModalCancel">
                    Cancel
                </button>
                <button class="delete-modal-btn delete-modal-btn-delete" id="deleteModalConfirm">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <script>
        let organizations = [];
        let ads = [];

        const ORGS_PER_PAGE = 6;
        const ADS_PER_PAGE = 6;
        let currentOrgPage = 1;
        let currentAdPage = 1;
        let currentAdFilterOrg = 'all';

        class ExpandableTabs {
            constructor(container, options = {}) {
                this.container = container;
                this.tabs = options.tabs || [];
                this.activeColor = options.activeColor || 'text-blue-600';
                this.onChange = options.onChange || (() => {});
                this.selected = null;
                this.init();
            }
            init() { this.render(); this.bindEvents(); }
            render() {
                this.container.innerHTML = '';
                this.tabs.forEach((tab, index) => {
                    const button = this.createTabButton(tab, index);
                    this.container.appendChild(button);
                });
            }
            createTabButton(tab, index) {
                const button = document.createElement('button');
                const isSelected = this.selected === index;
                button.className = `tab-button relative flex items-center text-sm font-medium tracking-wide transition-all duration-[600ms] ${isSelected ? 'selected' : ''}`;
                button.style.color = isSelected ? (this.activeColor || 'rgb(147, 197, 253)') : 'rgba(255, 255, 255, 0.6)';
                button.dataset.index = index;
                button.innerHTML = `
                    <div class="flex-shrink-0"><i data-lucide="${tab.icon}" class="w-4 h-4"></i></div>
                    <span class="tab-text ${isSelected ? 'expanded' : ''}">${tab.title}</span>
                `;
                button.addEventListener('mouseenter', () => !button.classList.contains('selected') && (button.style.color = 'rgba(255, 255, 255, 0.9)'));
                button.addEventListener('mouseleave', () => !button.classList.contains('selected') && (button.style.color = 'rgba(255, 255, 255, 0.6)'));
                return button;
            }
            handleSelect(index) {
                this.selected = index;
                const buttons = this.container.querySelectorAll('.tab-button');
                buttons.forEach(button => {
                    const buttonIndex = parseInt(button.dataset.index);
                    const textElement = button.querySelector('.tab-text');
                    const isSelected = this.selected === buttonIndex;
                    button.classList.toggle('selected', isSelected);
                    textElement.classList.toggle('expanded', isSelected);
                    button.style.color = isSelected ? (this.activeColor || 'rgb(147, 197, 253)') : 'rgba(255, 255, 255, 0.6)';
                });
                this.onChange(this.selected);
            }
            bindEvents() {
                this.container.addEventListener('click', (e) => {
                    const button = e.target.closest('.tab-button');
                    if (button && button.dataset.index !== undefined) {
                        this.handleSelect(parseInt(button.dataset.index));
                    }
                });
            }
        }

        function showContentSection(tabTitle) {
            if (tabTitle === 'Home') {
                window.location.href = '/admin_login';
                return;
            }
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            let sectionId = '';
            if (tabTitle === 'Organizations') sectionId = 'organizations';
            if (tabTitle === 'Ads') sectionId = 'ads';
            if (sectionId) {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.add('active');
                    if (sectionId === 'organizations') {
                        renderOrganizations();
                    } else if (sectionId === 'ads') {
                        renderAds();
                        populateOrganizationFilter();
                        populateAdOrganizationDropdown();
                    }
                }
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            let bgColor = type === 'error' ? 'bg-red-600' : type === 'warning' ? 'bg-yellow-600' : 'bg-green-600';
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => { document.body.removeChild(toast); }, 300);
            }, 3000);
        }

        // --- Organization Management ---
        async function fetchOrganizations() {
            try {
                const response = await fetch('/api/organizations');
                organizations = await response.json();
                renderOrganizations();
            } catch (error) {
                console.error('Error fetching organizations:', error);
                showToast('Failed to load organizations.', 'error');
            }
        }

        function renderOrganizations() {
            const organizationsGrid = document.getElementById('organizationsGrid');
            const noOrganizationsFound = document.getElementById('no-organizations-found');
            const organizationSearchInput = document.getElementById('organizationSearch');
            const searchTerm = organizationSearchInput.value.toLowerCase();
            organizationsGrid.innerHTML = '';

            const filteredOrgs = organizations.filter(org =>
                org.organization.toLowerCase().includes(searchTerm)
            );

            const startIndex = (currentOrgPage - 1) * ORGS_PER_PAGE;
            const endIndex = startIndex + ORGS_PER_PAGE;
            const paginatedOrgs = filteredOrgs.slice(startIndex, endIndex);

            if (paginatedOrgs.length === 0) {
                noOrganizationsFound.classList.remove('hidden');
                organizationsGrid.classList.add('hidden');
            } else {
                noOrganizationsFound.classList.add('hidden');
                organizationsGrid.classList.remove('hidden');
                paginatedOrgs.forEach(org => {
                    const orgTile = document.createElement('div');
                    orgTile.className = 'organization-tile';
                    orgTile.innerHTML = `
                        <div class="flex justify-center mb-4">
                            <img src="${org.logo || 'https://via.placeholder.com/50'}" alt="${org.organization} Logo" class="w-20 h-20 rounded-full object-cover border border-white/10">
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-2">${org.organization}</h3>
                        <p class="text-white/70 text-sm">Share: ${org.percentage}%</p>
                        <div class="actions">
                            <button class="action-btn" data-action="edit-org" data-id="${org.id}" title="Edit Organization"><i data-lucide="pencil" class="w-4 h-4 text-white"></i></button>
                            <button class="action-btn" data-action="delete-org" data-id="${org.id}" data-name="${org.organization}" title="Delete Organization"><i data-lucide="trash" class="w-4 h-4 text-white"></i></button>
                        </div>
                    `;
                    organizationsGrid.appendChild(orgTile);
                });
            }
            renderOrganizationPagination(filteredOrgs.length);
            lucide.createIcons();
        }

        function renderOrganizationPagination(totalOrgs) {
            const paginationContainer = document.getElementById('organizationPagination');
            paginationContainer.innerHTML = '';
            const totalPages = Math.ceil(totalOrgs / ORGS_PER_PAGE);

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.className = `pagination-button ${i === currentOrgPage ? 'active' : ''}`;
                button.textContent = i;
                button.addEventListener('click', () => {
                    currentOrgPage = i;
                    renderOrganizations();
                });
                paginationContainer.appendChild(button);
            }
        }

        function openOrganizationModal(org = null) {
            const modal = document.getElementById('organizationModal');
            const title = document.getElementById('organizationModalTitle');
            const form = document.getElementById('organizationForm');
            const orgLogoUpload = document.getElementById('orgLogoUpload');
            const orgLogoFilename = document.getElementById('org-logo-filename');
            const orgName = document.getElementById('orgName');
            const orgPercentage = document.getElementById('orgPercentage');
            const saveBtn = document.getElementById('organizationModalSave');

            form.reset();
            orgLogoFilename.textContent = 'Click or drop image here';
            orgLogoFilename.classList.add('file-input-placeholder');

            if (org) {
                title.textContent = 'Edit Organization';
                orgName.value = org.organization;
                orgPercentage.value = org.percentage;
                // For logo, if editing, you might want to show current logo or filename
                // For now, just reset the input
                saveBtn.textContent = 'Save Changes';
                form.dataset.editId = org.id;
            } else {
                title.textContent = 'Create New Organization';
                saveBtn.textContent = 'Create Organization';
                delete form.dataset.editId;
            }

            modal.classList.add('show');
        }

        function closeOrganizationModal() {
            document.getElementById('organizationModal').classList.remove('show');
        }

        document.getElementById('createNewOrganizationBtn').addEventListener('click', () => openOrganizationModal());
        document.getElementById('organizationModalCancel').addEventListener('click', closeOrganizationModal);
        document.getElementById('organizationModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('organizationModal')) closeOrganizationModal();
        });

        document.getElementById('org-logo-dropzone').addEventListener('click', () => document.getElementById('orgLogoUpload').click());
        document.getElementById('orgLogoUpload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const filenameSpan = document.getElementById('org-logo-filename');
            if (file) {
                filenameSpan.textContent = file.name;
                filenameSpan.classList.remove('file-input-placeholder');
            } else {
                filenameSpan.textContent = 'Click or drop image here';
                filenameSpan.classList.add('file-input-placeholder');
            }
        });

        document.getElementById('organizationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const orgId = form.dataset.editId;
            const formData = new FormData();
            formData.append('organization', document.getElementById('orgName').value);
            formData.append('percentage', document.getElementById('orgPercentage').value);
            const logoFile = document.getElementById('orgLogoUpload').files[0];
            if (logoFile) {
                formData.append('org_logo', logoFile);
            }

            const url = orgId ? `/api/organizations/${orgId}` : '/api/organizations';
            const method = orgId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to save organization');
                }

                showToast(`Organization ${orgId ? 'updated' : 'created'} successfully!`, 'success');
                fetchOrganizations();
                closeOrganizationModal();
            } catch (error) {
                console.error('Error saving organization:', error);
                showToast(error.message, 'error');
            }
        });

        document.getElementById('organizationsGrid').addEventListener('click', (e) => {
            const actionBtn = e.target.closest('.action-btn');
            if (!actionBtn) return;

            const action = actionBtn.dataset.action;
            const orgId = actionBtn.dataset.id;
            const orgName = actionBtn.dataset.name;
            const org = organizations.find(o => o.id == orgId);

            if (!org) return;

            if (action === 'edit-org') {
                openOrganizationModal(org);
            } else if (action === 'delete-org') {
                showDeleteModal(`organization "${orgName}" and all associated ads`, async () => {
                    try {
                        const response = await fetch(`/api/organizations/${orgId}`, { method: 'DELETE' });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Failed to delete organization');
                        }
                        showToast(`Organization "${orgName}" deleted successfully!`, 'success');
                        fetchOrganizations();
                        fetchAds(); // Also refetch ads to update the UI
                    } catch (error) {
                        console.error('Error deleting organization:', error);
                        showToast(error.message, 'error');
                    }
                });
            }
        });

        document.getElementById('organizationSearch').addEventListener('input', () => {
            currentOrgPage = 1; // Reset to first page on filter change
            renderOrganizations();
        });

        // --- Ad Management ---
        async function fetchAds() {
            try {
                const response = await fetch('/api/ads');
                ads = await response.json();
                renderAds();
            } catch (error) {
                console.error('Error fetching ads:', error);
                showToast('Failed to load ads.', 'error');
            }
        }

        function renderAds() {
            const adsList = document.getElementById('adsList');
            const noAdsFound = document.getElementById('no-ads-found');
            adsList.innerHTML = '';

            const filteredAds = currentAdFilterOrg === 'all'
                ? ads
                : ads.filter(ad => ad.organization_id == currentAdFilterOrg);

            const startIndex = (currentAdPage - 1) * ADS_PER_PAGE;
            const endIndex = startIndex + ADS_PER_PAGE;
            const paginatedAds = filteredAds.slice(startIndex, endIndex);

            if (paginatedAds.length === 0) {
                noAdsFound.classList.remove('hidden');
                adsList.classList.add('hidden');
            } else {
                noAdsFound.classList.add('hidden');
                adsList.classList.remove('hidden');
                paginatedAds.forEach(ad => {
                    const adItem = document.createElement('div');
                    adItem.className = 'ad-item';
                    const org = organizations.find(o => o.id == ad.organization_id);
                    const orgName = org ? org.organization : 'Unknown';
                    adItem.innerHTML = `
                        <div class="flex justify-center mb-4">
                            <img src="${ad.image || 'https://via.placeholder.com/100x75'}" alt="${ad.title} Thumbnail" class="w-20 h-20 object-cover rounded-lg aspect-square">
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-2">${ad.title}</h3>
                        <p class="text-white/70 text-sm mb-2"> ${orgName}</p>
                        <a href="${ad.url}" target="_blank" class="text-blue-400 hover:underline text-sm block truncate">${ad.url}</a>
                        <div class="actions">
                            <button class="action-btn" data-action="edit-ad" data-id="${ad.id}" title="Edit Ad"><i data-lucide="pencil" class="w-4 h-4 text-white"></i></button>
                            <button class="action-btn" data-action="delete-ad" data-id="${ad.id}" data-name="${ad.title}" title="Delete Ad"><i data-lucide="trash" class="w-4 h-4 text-white"></i></button>
                        </div>
                    `;
                    adsList.appendChild(adItem);
                });
            }
            renderAdPagination(filteredAds.length);
            lucide.createIcons();
        }

        function renderAdPagination(totalAds) {
            const paginationContainer = document.getElementById('adPagination');
            paginationContainer.innerHTML = '';
            const totalPages = Math.ceil(totalAds / ADS_PER_PAGE);

            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.className = `pagination-button ${i === currentAdPage ? 'active' : ''}`;
                button.textContent = i;
                button.addEventListener('click', () => {
                    currentAdPage = i;
                    renderAds();
                });
                paginationContainer.appendChild(button);
            }
        }

        function populateOrganizationFilter() {
            const filter = document.getElementById('organizationFilter');
            filter.innerHTML = '<option value="all">Filter by Organization (All)</option>';
            organizations.forEach(org => {
                const option = document.createElement('option');
                option.value = org.id;
                option.textContent = org.organization;
                filter.appendChild(option);
            });
            filter.value = currentAdFilterOrg; // Set current filter
        }

        function populateAdOrganizationDropdown() {
            const dropdown = document.getElementById('adOrganization');
            dropdown.innerHTML = '<option value="">Select an Organization</option>';
            organizations.forEach(org => {
                const option = document.createElement('option');
                option.value = org.id;
                option.textContent = org.organization;
                dropdown.appendChild(option);
            });
        }

        function openAdModal(ad = null) {
            const modal = document.getElementById('adModal');
            const title = document.getElementById('adModalTitle');
            const form = document.getElementById('adForm');
            const adImageUpload = document.getElementById('adImageUpload');
            const adImageFilename = document.getElementById('ad-image-filename');
            const adOrganization = document.getElementById('adOrganization');
            const adTitle = document.getElementById('adTitle');
            const adDescription = document.getElementById('adDescription');
            const adHyperlink = document.getElementById('adHyperlink');
            const saveBtn = document.getElementById('adModalSave');

            form.reset();
            adImageFilename.textContent = 'Click or drop image here';
            adImageFilename.classList.add('file-input-placeholder');
            populateAdOrganizationDropdown(); // Ensure dropdown is fresh

            if (ad) {
                title.textContent = 'Edit Ad';
                adOrganization.value = ad.organization_id;
                adTitle.value = ad.title;
                adDescription.value = ad.description || '';
                adHyperlink.value = ad.url;
                saveBtn.textContent = 'Save Changes';
                form.dataset.editId = ad.id;
            } else {
                title.textContent = 'Add New Ad';
                saveBtn.textContent = 'Add Ad';
                delete form.dataset.editId;
            }

            modal.classList.add('show');
        }

        function closeAdModal() {
            document.getElementById('adModal').classList.remove('show');
        }

        document.getElementById('addNewAdBtn').addEventListener('click', () => openAdModal());
        document.getElementById('adModalCancel').addEventListener('click', closeAdModal);
        document.getElementById('adModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('adModal')) closeAdModal();
        });

        document.getElementById('ad-image-dropzone').addEventListener('click', () => document.getElementById('adImageUpload').click());
        document.getElementById('adImageUpload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const filenameSpan = document.getElementById('ad-image-filename');
            if (file) {
                filenameSpan.textContent = file.name;
                filenameSpan.classList.remove('file-input-placeholder');
            } else {
                filenameSpan.textContent = 'Click or drop image here';
                filenameSpan.classList.add('file-input-placeholder');
            }
        });

        document.getElementById('adForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const adId = form.dataset.editId;
            const formData = new FormData();
            formData.append('organization_id', document.getElementById('adOrganization').value);
            formData.append('title', document.getElementById('adTitle').value);
            formData.append('description', document.getElementById('adDescription').value);
            formData.append('url', document.getElementById('adHyperlink').value);

            const adImageFile = document.getElementById('adImageUpload').files[0];
            if (adImageFile) {
                formData.append('ad_image', adImageFile);
            }
            
            const url = adId ? `/api/ads/${adId}` : '/api/ads_post';
            const method = adId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to save ad');
                }

                showToast(`Ad ${adId ? 'updated' : 'created'} successfully!`, 'success');
                fetchAds();
                fetchOrganizations(); // To update ad counts if you implement that
                closeAdModal();
            } catch (error) {
                console.error('Error saving ad:', error);
                showToast(error.message, 'error');
            }
        });

        document.getElementById('adsList').addEventListener('click', (e) => {
            const actionBtn = e.target.closest('.action-btn');
            if (!actionBtn) return;

            const action = actionBtn.dataset.action;
            const adId = actionBtn.dataset.id;
            const adName = actionBtn.dataset.name;
            const ad = ads.find(a => a.id == adId);

            if (!ad) return;

            if (action === 'edit-ad') {
                openAdModal(ad);
            } else if (action === 'delete-ad') {
                showDeleteModal(`ad "${adName}"`, async () => {
                    try {
                        const response = await fetch(`/api/ads/${adId}`, { method: 'DELETE' });
                        if (!response.ok) {
                           const errorData = await response.json();
                            throw new Error(errorData.message || 'Failed to delete ad');
                        }
                        showToast(`Ad "${adName}" deleted successfully!`, 'success');
                        fetchAds();
                    } catch (error) {
                        console.error('Error deleting ad:', error);
                        showToast(error.message, 'error');
                    }
                });
            }
        });

        document.getElementById('organizationFilter').addEventListener('change', (e) => {
            currentAdFilterOrg = e.target.value;
            currentAdPage = 1; // Reset to first page on filter change
            renderAds();
        });

        // --- General Delete Modal ---
        let confirmDeleteCallback = null;
        function showDeleteModal(itemName, onConfirm) {
            const modal = document.getElementById('deleteModal');
            const message = document.getElementById('deleteModalMessage');
            const confirmBtn = document.getElementById('deleteModalConfirm');
            const cancelBtn = document.getElementById('deleteModalCancel');

            message.innerHTML = `Are you sure you want to delete <strong>${itemName}</strong>?<br>This action cannot be undone.`;
            modal.classList.add('show');
            confirmDeleteCallback = onConfirm;

            const handleConfirm = () => {
                hideDeleteModal();
                if (confirmDeleteCallback) confirmDeleteCallback();
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            const handleCancel = () => {
                hideDeleteModal();
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
            modal.addEventListener('click', (e) => { if (e.target === modal) handleCancel(); });
            document.addEventListener('keydown', function onEscape(e) {
                if (e.key === 'Escape') {
                    handleCancel();
                    document.removeEventListener('keydown', onEscape);
                }
            });
        }

        function hideDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            confirmDeleteCallback = null;
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            const navbarTabsData = [
                { title: "Admin Panel Home", icon: "home" },
                { title: "Organizations", icon: "building-2" },
                { title: "Ads", icon: "megaphone" }
            ];
            const expandableTabs = new ExpandableTabs(document.getElementById('navbarTabs'), {
                tabs: navbarTabsData,
                activeColor: 'text-blue-400',
                onChange: (index) => {
                    if (index !== null) {
                        if (navbarTabsData[index].title === "Admin Panel Home") {
                            window.location.href = '/admin_login';
                        } else {
                            showContentSection(navbarTabsData[index].title);
                        }
                    }
                }
            });
            expandableTabs.handleSelect(1); // Default to Organizations tab
            
            // Initial data fetch
            fetchOrganizations();
            fetchAds();
        });
    </script>
</body>
</html>