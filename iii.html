<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tailwind CSS Flipbook</title>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/page-flip/dist/css/page-flip.min.css">
    <style>
        .flipbook-page.--odd {
            background-color: #e9ecef;
        }
        .flipbook-page[data-density="hard"] {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            font-size: 2rem;
        }
        .stf__parent {
            position: relative;
            z-index: 1;
        }
        .stf__block {
            position: relative;
            z-index: 2;
        }
        .stf__item {
            position: absolute;
            z-index: 2;
        }
        .stf__item.--active {
            z-index: 5;
        }
        .stf__outerShadow {
            z-index: 3;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        .book-container {
            border: 3px solid #2c3e50;
            border-radius: 8px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .page-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background-color: #f5f5f5;
        }
        .page-loading {
            width: 30px;
            height: 30px;
            border: 3px solid #e0e0e0;
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        .pdf-link-overlay {
            position: absolute;
            background-color: rgba(0, 123, 255, 0.05);
            transition: background-color 0.2s;
            z-index: 1000;
            cursor: pointer;
        }
        .pdf-link-overlay:hover {
            background-color: rgba(0, 123, 255, 0.2);
        }
    </style>
</head>
<body class="m-0 font-sans antialiased min-h-screen flex flex-col overflow-hidden">
    <div class="App text-center flex-grow flex flex-col">
        <header class="App-header bg-gray-800 flex-grow flex flex-col items-center justify-center text-2xl text-white p-5 box-border">
            <div id="flipbook-wrapper" class="relative w-[1000px] h-[700px] mt-5 mx-auto book-container">
                <!-- Loading overlay -->
                <div id="loading-overlay" class="absolute inset-0 bg-gray-800 bg-opacity-80 flex flex-col justify-center items-center z-50">
                    <svg class="spinner w-16 h-16 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-white">Loading your PDF...</p>
                </div>
                <div id="my-flipbook-container" class="w-[1000px] h-[700px]">
                </div>
            </div>
        </header>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const flipBookElement = document.getElementById('my-flipbook-container');
            const loadingOverlay = document.getElementById('loading-overlay');
            let pageFlip;
            let pdfDocument = null;
            let pageCache = new Map();

            function createPageDiv(pageNumber, totalPages) {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'flipbook-page bg-gray-50 text-gray-800 flex flex-col justify-center items-center shadow-lg box-border';
                pageDiv.setAttribute('data-page-number', pageNumber);

                if (pageNumber === 1 || pageNumber === totalPages) {
                    pageDiv.setAttribute('data-density', 'hard');
                }

                const placeholder = document.createElement('div');
                placeholder.className = 'page-placeholder';
                placeholder.innerHTML = `<div class="page-loading"></div>`;
                pageDiv.appendChild(placeholder);
                return pageDiv;
            }

            async function renderPageToCanvas(pageNumber) {
                try {
                    if (pageCache.has(pageNumber)) {
                        return pageCache.get(pageNumber);
                    }
                    const page = await pdfDocument.getPage(pageNumber);
                    const pageFlipWidth = 500;
                    const pageFlipHeight = 700;
                    const pagePadding = 0; 

                    const containerWidth = pageFlipWidth - (2 * pagePadding);
                    const containerHeight = pageFlipHeight - (2 * pagePadding);

                    const viewportOriginal = page.getViewport({ scale: 1.0 });
                    const baseScale = Math.min(
                        containerWidth / viewportOriginal.width,
                        containerHeight / viewportOriginal.height
                    );
                    const viewport = page.getViewport({ scale: baseScale });

                    const pixelRatio = window.devicePixelRatio || 1;

                    const pageContentHolder = document.createElement('div');
                    pageContentHolder.style.position = 'relative';
                    pageContentHolder.style.width = `${viewport.width}px`;
                    pageContentHolder.style.height = `${viewport.height}px`;
                    // MODIFICATION: Add margin: auto to ensure centering within the flex parent (flipbook-page)
                    pageContentHolder.style.margin = 'auto';

                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width * pixelRatio;
                    canvas.height = viewport.height * pixelRatio;
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    pageContentHolder.appendChild(canvas);

                    const context = canvas.getContext('2d');
                    context.scale(pixelRatio, pixelRatio);

                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    await page.render(renderContext).promise;

                    const linkContainer = document.createElement('div');
                    linkContainer.style.position = 'absolute';
                    linkContainer.style.top = '0';
                    linkContainer.style.left = '0';
                    linkContainer.style.width = '100%';
                    linkContainer.style.height = '100%';
                    linkContainer.style.pointerEvents = 'none';

                    const annotations = await page.getAnnotations();
                    let linkCount = 0;
                    for (const annotation of annotations) {
                        if (annotation.subtype === 'Link') {
                            linkCount++;
                            const rect = viewport.convertToViewportRectangle(annotation.rect);
                            const [x1, y1, x2, y2] = rect;

                            const linkOverlay = document.createElement('div');
                            linkOverlay.className = 'pdf-link-overlay';
                            const linkOffsetX = 0;
                            const linkOffsetY = 0;
                            const widthAdjustment = 0;

                            linkOverlay.style.left = `${Math.min(x1, x2) + linkOffsetX}px`;
                            linkOverlay.style.top = `${Math.min(y1, y2) + linkOffsetY}px`;
                            linkOverlay.style.width = `${Math.abs(x2 - x1) + widthAdjustment}px`;
                            linkOverlay.style.height = `${Math.abs(y2 - y1)}px`;
                            linkOverlay.style.pointerEvents = 'auto';

                            if (annotation.url) {
                                linkOverlay.title = annotation.url;
                                linkOverlay.setAttribute('data-url', annotation.url);
                                linkOverlay.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                    console.log("External link clicked:", annotation.url);
                                    window.open(annotation.url, '_blank');
                                }, true);
                            }
                            else if (annotation.dest) {
                                linkOverlay.title = 'Go to page';
                                linkOverlay.setAttribute('data-dest', JSON.stringify(annotation.dest));
                                linkOverlay.addEventListener('click', async (e) => {
                                    e.stopPropagation();
                                    e.preventDefault();
                                    try {
                                        const destArray = JSON.parse(linkOverlay.getAttribute('data-dest'));
                                        console.log("Internal link clicked, dest data:", destArray);
                                        const destInfo = await pdfDocument.getDestination(destArray);
                                        if (destInfo && destInfo.length > 0) {
                                            const pageRef = destInfo[0];
                                            const targetPageNum = await pdfDocument.getPageIndex(pageRef) + 1;
                                            console.log("Navigating to page", targetPageNum);
                                            if (pageFlip) {
                                                pageFlip.flip(targetPageNum - 1);
                                            }
                                        }
                                    } catch (error) {
                                        console.error('Error navigating to internal link:', error);
                                    }
                                }, true);
                            }
                            linkContainer.appendChild(linkOverlay);
                        }
                    }
                    console.log(`Page ${pageNumber} has ${linkCount} links`);
                    if (linkCount > 0) {
                        pageContentHolder.appendChild(linkContainer);
                    }

                    pageCache.set(pageNumber, pageContentHolder);
                    return pageContentHolder;
                } catch (error) {
                    console.error(`Error rendering page ${pageNumber}:`, error);
                    const errorElem = document.createElement('div');
                    errorElem.className = 'text-red-500 p-4';
                    errorElem.textContent = `Error loading page ${pageNumber}`;
                    return errorElem;
                }
            }

            async function updatePageContent(pageNumber, totalPages) {
                const pageSelector = `[data-page-number="${pageNumber}"]`;
                const pageDiv = document.querySelector(pageSelector);
                if (!pageDiv) return;

                const contentHolder = await renderPageToCanvas(pageNumber);
                pageDiv.innerHTML = ''; 
                pageDiv.appendChild(contentHolder);

                if (pageNumber !== 1 && pageNumber !== totalPages) {
                    const pageNumDisplay = document.createElement('p');
                    pageNumDisplay.className = 'absolute bottom-2 right-2 text-xs text-gray-400';
                    pageNumDisplay.textContent = `Page ${pageNumber - 1}`; 
                    if(getComputedStyle(pageDiv).position === 'static') {
                        pageDiv.style.position = 'relative'; 
                    }
                    pageDiv.appendChild(pageNumDisplay);
                }
            }

            async function preRenderPages(currentPage, totalPages) {
                const range = 2; 
                const startPage = Math.max(1, currentPage - range);
                const endPage = Math.min(totalPages, currentPage + range);

                const pagesToRender = [];
                for (let i = startPage; i <= endPage; i++) {
                    const pageDiv = document.querySelector(`[data-page-number="${i}"]`);
                    if (!pageCache.has(i) && pageDiv) { 
                        pagesToRender.push(updatePageContent(i, totalPages));
                    }
                }
                if (pagesToRender.length > 0) {
                    await Promise.all(pagesToRender);
                }
            }

            async function loadPDF(pdfUrl) {
                try {
                    loadingOverlay.style.display = 'flex';
                    flipBookElement.innerHTML = ''; 
                    pageCache.clear(); 

                    const loadingTask = pdfjsLib.getDocument(pdfUrl);
                    pdfDocument = await loadingTask.promise;
                    console.log('PDF loaded, pages:', pdfDocument.numPages);

                    const totalPages = pdfDocument.numPages;

                    for (let i = 1; i <= totalPages; i++) {
                        const pageDiv = createPageDiv(i, totalPages);
                        flipBookElement.appendChild(pageDiv);
                    }

                    initFlipbook();

                    const initialPages = [1];
                    if (totalPages > 1) initialPages.push(2);
                    if (totalPages > 2) initialPages.push(3); 
                    if (totalPages > 0) initialPages.push(totalPages); 

                    await Promise.all(
                        [...new Set(initialPages)] 
                        .filter(pn => pn <= totalPages && pn > 0) 
                        .map(pageNum => updatePageContent(pageNum, totalPages))
                    );

                    loadingOverlay.style.display = 'none';

                } catch (error) {
                    console.error('Error loading PDF:', error);
                    flipBookElement.innerHTML = `<div class="p-5 text-red-500">Failed to load PDF: ${error.message}</div>`;
                    loadingOverlay.style.display = 'none';
                }
            }

            function initFlipbook() {
                if (pageFlip) {
                    pageFlip.destroy();
                    pageFlip = null;
                }

                pageFlip = new St.PageFlip(flipBookElement, {
                    width: 500,          
                    height: 700,         
                    size: "fixed",       
                    minWidth: 500, maxWidth: 500, minHeight: 700, maxHeight: 700,
                    maxShadowOpacity: 0.5, 
                    showCover: true,       
                    mobileScrollSupport: true, 
                    flippingTime: 1000,    
                    usePortrait: false,    
                    startPage: 0,          
                    startZIndex: 20,       
                    autoSize: false,        
                    drawShadow: true,      
                });

                pageFlip.loadFromHTML(document.querySelectorAll('#my-flipbook-container > .flipbook-page'));
                console.log('Flipbook initialized');

                pageFlip.on('flip', (e) => {
                    console.log('Flipped to page index:', e.data); 
                    const currentPageNumber = e.data + 1; 
                    if (pdfDocument) {
                        const pagesInView = [currentPageNumber];
                        if (!pageFlip.getSettings().usePortrait && currentPageNumber < pdfDocument.numPages) {
                             pagesInView.push(currentPageNumber + 1);
                        }
                        pagesInView.forEach(pn => preRenderPages(pn, pdfDocument.numPages));
                    }
                });
            }

            const pdfUrl = 'CXO TechBOT October 2024.pdf'; 
            loadPDF(pdfUrl);
        });
    </script>
</body>
</html>